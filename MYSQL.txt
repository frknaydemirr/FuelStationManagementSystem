-- AUTOMATED FUEL STATION MANAGEMENT SYSTEM - DATABASE SCRIPT
-- Centralized Business Logic and Normalized Schema
-- Compliant with CENG 301 Project Guidelines

DELIMITER $$

-- 1. EMPLOYEE MANAGEMENT
-- Table includes CHECK constraints for data validation [cite: 196]
CREATE TABLE Employees (
    EmployeeID INT PRIMARY KEY AUTO_INCREMENT,
    FirstName VARCHAR(50) NOT NULL,
    LastName VARCHAR(50) NOT NULL,
    Position VARCHAR(50) NOT NULL,
    TC_KimlikNo VARCHAR(11) UNIQUE NOT NULL,
    HireDate DATE NOT NULL,
    Salary DECIMAL(10, 2) NOT NULL,
    -- Business Rule: Validating shift names at DB level [cite: 196]
    Shift VARCHAR(20) CHECK (Shift IN ('Day', 'Night', 'Flexible')),
    Email VARCHAR(100)
)$$

-- 2. HANDLING MULTI-VALUED ATTRIBUTES
-- PhoneNumber is a multi-valued attribute; mapped to a separate table for Normalization [cite: 169, 173]
CREATE TABLE EmployeePhones (
    PhoneID INT PRIMARY KEY AUTO_INCREMENT,
    EmployeeID INT,
    PhoneNumber VARCHAR(15),
    FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID) ON DELETE CASCADE
)$$

-- 3. USER AUTHENTICATION
CREATE TABLE Users (
    UserID INT PRIMARY KEY AUTO_INCREMENT,
    EmployeeID INT NOT NULL,
    Username VARCHAR(50) UNIQUE NOT NULL,
    Password VARCHAR(255) NOT NULL,
    IsActive BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID) ON DELETE CASCADE
)$$

-- 4. FUEL AND INVENTORY
CREATE TABLE FuelTypes (
    FuelTypeID INT PRIMARY KEY AUTO_INCREMENT,
    FuelName VARCHAR(50) UNIQUE NOT NULL,
    -- Business Rule: Fuel price must be positive [cite: 195]
    CurrentPricePerLiter DECIMAL(8, 4) NOT NULL CHECK (CurrentPricePerLiter > 0),
    CurrentStockLiters DECIMAL(12, 2) NOT NULL DEFAULT 0,
    LastUpdated DATETIME DEFAULT CURRENT_TIMESTAMP
)$$

CREATE TABLE FuelPumps (
    PumpID INT PRIMARY KEY,
    Status VARCHAR(20) NOT NULL CHECK (Status IN ('Available', 'In Use', 'Maintenance')),
    LastMaintenanceDate DATE,
    FuelTypeCapacity INT
)$$

-- 5. TRANSACTIONAL DATA
CREATE TABLE SalesTransactions (
    TransactionID BIGINT PRIMARY KEY AUTO_INCREMENT,
    TransactionDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    EmployeeID INT NOT NULL,
    CustomerID INT,
    FuelTypeID INT NOT NULL,
    PumpID INT NOT NULL,
    LitersSold DECIMAL(10, 2) NOT NULL CHECK (LitersSold > 0),
    PriceAtSale DECIMAL(8, 4) NOT NULL,
    TotalAmount DECIMAL(10, 2) NOT NULL,
    PaymentMethod VARCHAR(50) NOT NULL,
    DiscountApplied DECIMAL(10, 2) DEFAULT 0.00,
    FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID),
    FOREIGN KEY (FuelTypeID) REFERENCES FuelTypes(FuelTypeID),
    FOREIGN KEY (PumpID) REFERENCES FuelPumps(PumpID)
)$$

-- 6. WEAK ENTITY IMPLEMENTATION
-- SaleDetails is a weak entity; using ON DELETE CASCADE for Referential Integrity [cite: 182, 187]
CREATE TABLE StoreSales (
    StoreID BIGINT PRIMARY KEY AUTO_INCREMENT,
    SaleDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    EmployeeID INT NOT NULL,
    TotalAmount DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID)
)$$

CREATE TABLE SaleDetails (
    DetailID BIGINT PRIMARY KEY AUTO_INCREMENT,
    StoreID BIGINT NOT NULL,
    ProductID INT NOT NULL,
    Quantity INT NOT NULL CHECK (Quantity > 0),
    PriceAtSale DECIMAL(8, 2) NOT NULL,
    -- Enforcing dependency on parent entity 
    FOREIGN KEY (StoreID) REFERENCES StoreSales(StoreID) ON DELETE CASCADE
)$$

-- 7. MANDATORY STORED PROCEDURE USAGE
-- Handles primary business function: fuel sales with atomic transaction [cite: 140, 153]
CREATE PROCEDURE SP_ComplexFuelSale(
    IN p_EmpID INT, IN p_CustID INT, IN p_FuelID INT, IN p_PumpID INT,
    IN p_Liters DECIMAL(10,2), IN p_Total DECIMAL(10,2), IN p_Method VARCHAR(50)
)
BEGIN
    DECLARE v_Price DECIMAL(8,4);
    START TRANSACTION; -- Ensuring Atomic Transaction [cite: 146]

    -- Fetch current price from DB to ensure consistency [cite: 147]
    SELECT CurrentPricePerLiter INTO v_Price FROM FuelTypes WHERE FuelTypeID = p_FuelID;

    -- Record the sale record [cite: 148]
    INSERT INTO SalesTransactions (EmployeeID, CustomerID, FuelTypeID, PumpID, LitersSold, PriceAtSale, TotalAmount, PaymentMethod)
    VALUES (p_EmpID, p_CustID, p_FuelID, p_PumpID, p_Liters, v_Price, p_Total, p_Method);

    -- Update inventory stock levels simultaneously [cite: 150]
    UPDATE FuelTypes SET CurrentStockLiters = CurrentStockLiters - p_Liters WHERE FuelTypeID = p_FuelID;

    COMMIT;
END$$

-- 8. EFFICIENT QUERY IMPLEMENTATION (EXPECTED METHOD)
-- Logic handled within SQL engine to find top performer [cite: 159, 167]
CREATE PROCEDURE SP_MostUsedPump()
BEGIN
    SELECT PumpID, SUM(LitersSold) as TotalLiters
    FROM SalesTransactions
    GROUP BY PumpID
    ORDER BY TotalLiters DESC
    LIMIT 1; -- Efficient SQL-side calculation following project manual [cite: 165]
END$$

-- 9. INITIAL DATA
INSERT INTO Employees (FirstName, LastName, Position, TC_KimlikNo, HireDate, Salary, Shift, Email) 
VALUES ('System', 'Admin', 'Manager', '00000000000', CURDATE(), 9999.99, 'Day', 'admin@fuelstation.com')$$

INSERT INTO Users (EmployeeID, Username, Password) 
VALUES (1, 'admin', '1234')$$

DELIMITER ;